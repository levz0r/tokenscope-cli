#!/bin/bash
# TokenScope CLI
# View and analyze your Claude Code usage statistics
# Version: 1.0.0

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m' # No Color

# Database location
DB_DIR="${CLAUDE_ANALYTICS_DIR:-$HOME/.claude/analytics}"
DB_FILE="${DB_DIR}/analytics.db"

# Check if database exists
check_db() {
    if [[ ! -f "$DB_FILE" ]]; then
        echo -e "${RED}Error: Analytics database not found at $DB_FILE${NC}"
        echo -e "${DIM}Run the installer or wait for your first Claude Code session to create it.${NC}"
        exit 1
    fi
}

# Format numbers with commas
format_number() {
    printf "%'d" "$1" 2>/dev/null || echo "$1"
}

# Show summary dashboard
show_summary() {
    check_db

    echo -e "${BOLD}${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${BOLD}${CYAN}                    CLAUDE CODE ANALYTICS                       ${NC}"
    echo -e "${BOLD}${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo

    # Total sessions
    TOTAL_SESSIONS=$(sqlite3 -cmd ".timeout 5000" "$DB_FILE" "SELECT COUNT(*) FROM sessions;")
    ACTIVE_SESSIONS=$(sqlite3 -cmd ".timeout 5000" "$DB_FILE" "SELECT COUNT(*) FROM sessions WHERE end_time IS NULL;")

    # Today's stats
    TODAY_SESSIONS=$(sqlite3 -cmd ".timeout 5000" "$DB_FILE" "SELECT COUNT(*) FROM sessions WHERE date(start_time) = date('now');")
    TODAY_TOOLS=$(sqlite3 -cmd ".timeout 5000" "$DB_FILE" "SELECT COUNT(*) FROM tool_uses WHERE date(timestamp) = date('now');")

    # Tool usage
    TOTAL_TOOLS=$(sqlite3 -cmd ".timeout 5000" "$DB_FILE" "SELECT COUNT(*) FROM tool_uses;")
    TOTAL_WRITES=$(sqlite3 -cmd ".timeout 5000" "$DB_FILE" "SELECT COUNT(*) FROM tool_uses WHERE tool_name = 'Write';")
    TOTAL_EDITS=$(sqlite3 -cmd ".timeout 5000" "$DB_FILE" "SELECT COUNT(*) FROM tool_uses WHERE tool_name = 'Edit';")
    TOTAL_READS=$(sqlite3 -cmd ".timeout 5000" "$DB_FILE" "SELECT COUNT(*) FROM tool_uses WHERE tool_name = 'Read';")
    TOTAL_BASH=$(sqlite3 -cmd ".timeout 5000" "$DB_FILE" "SELECT COUNT(*) FROM tool_uses WHERE tool_name = 'Bash';")

    # File stats
    TOTAL_FILES=$(sqlite3 -cmd ".timeout 5000" "$DB_FILE" "SELECT COUNT(DISTINCT file_path) FROM file_changes;")
    LINES_ADDED=$(sqlite3 -cmd ".timeout 5000" "$DB_FILE" "SELECT COALESCE(SUM(lines_added), 0) FROM file_changes;")
    LINES_REMOVED=$(sqlite3 -cmd ".timeout 5000" "$DB_FILE" "SELECT COALESCE(SUM(lines_removed), 0) FROM file_changes;")

    # Git stats
    TOTAL_GIT=$(sqlite3 -cmd ".timeout 5000" "$DB_FILE" "SELECT COUNT(*) FROM git_operations;")
    TOTAL_COMMITS=$(sqlite3 -cmd ".timeout 5000" "$DB_FILE" "SELECT COUNT(*) FROM git_operations WHERE operation_type = 'commit';")
    TOTAL_PUSHES=$(sqlite3 -cmd ".timeout 5000" "$DB_FILE" "SELECT COUNT(*) FROM git_operations WHERE operation_type = 'push';")
    TOTAL_PRS=$(sqlite3 -cmd ".timeout 5000" "$DB_FILE" "SELECT COUNT(*) FROM git_operations WHERE operation_type = 'pr-create';")

    echo -e "${BOLD}ðŸ“Š Overview${NC}"
    echo -e "   Total Sessions:     ${GREEN}$(format_number $TOTAL_SESSIONS)${NC}"
    echo -e "   Active Sessions:    ${YELLOW}$(format_number $ACTIVE_SESSIONS)${NC}"
    echo -e "   Today's Sessions:   ${CYAN}$(format_number $TODAY_SESSIONS)${NC}"
    echo

    echo -e "${BOLD}ðŸ›   Tool Usage${NC}"
    echo -e "   Total Tool Calls:   ${GREEN}$(format_number $TOTAL_TOOLS)${NC} (${CYAN}$TODAY_TOOLS${NC} today)"
    echo -e "   â”œâ”€ Write:           $(format_number $TOTAL_WRITES)"
    echo -e "   â”œâ”€ Edit:            $(format_number $TOTAL_EDITS)"
    echo -e "   â”œâ”€ Read:            $(format_number $TOTAL_READS)"
    echo -e "   â””â”€ Bash:            $(format_number $TOTAL_BASH)"
    echo

    echo -e "${BOLD}ðŸ“ File Changes${NC}"
    echo -e "   Unique Files:       ${GREEN}$(format_number $TOTAL_FILES)${NC}"
    echo -e "   Lines Added:        ${GREEN}+$(format_number $LINES_ADDED)${NC}"
    echo -e "   Lines Removed:      ${RED}-$(format_number $LINES_REMOVED)${NC}"
    NET_CHANGE=$((LINES_ADDED - LINES_REMOVED))
    if [[ $NET_CHANGE -ge 0 ]]; then
        echo -e "   Net Change:         ${GREEN}+$(format_number $NET_CHANGE)${NC}"
    else
        echo -e "   Net Change:         ${RED}$(format_number $NET_CHANGE)${NC}"
    fi
    echo

    echo -e "${BOLD}ðŸ”€ Git Operations${NC}"
    echo -e "   Total Git Commands: ${GREEN}$(format_number $TOTAL_GIT)${NC}"
    echo -e "   â”œâ”€ Commits:         $(format_number $TOTAL_COMMITS)"
    echo -e "   â”œâ”€ Pushes:          $(format_number $TOTAL_PUSHES)"
    echo -e "   â””â”€ PRs Created:     $(format_number $TOTAL_PRS)"
    echo
}

# Show sessions list
show_sessions() {
    check_db
    local limit="${1:-10}"

    echo -e "${BOLD}${CYAN}Recent Sessions (last $limit)${NC}"
    echo -e "${DIM}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"

    sqlite3 -cmd ".timeout 5000" -header -column "$DB_FILE" "
        SELECT
            substr(session_id, 1, 8) as 'Session',
            project_name as 'Project',
            datetime(start_time, 'localtime') as 'Started',
            CASE
                WHEN end_time IS NULL THEN 'Active'
                ELSE strftime('%H:%M:%S', julianday(end_time) - julianday(start_time))
            END as 'Duration',
            (SELECT COUNT(*) FROM tool_uses t WHERE t.session_id = s.session_id) as 'Tools'
        FROM sessions s
        ORDER BY start_time DESC
        LIMIT $limit;
    "
}

# Show tool usage breakdown
show_tools() {
    check_db
    local days="${1:-7}"

    echo -e "${BOLD}${CYAN}Tool Usage (last $days days)${NC}"
    echo -e "${DIM}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"

    sqlite3 -cmd ".timeout 5000" -header -column "$DB_FILE" "
        SELECT
            tool_name as 'Tool',
            COUNT(*) as 'Uses',
            SUM(CASE WHEN success = 1 THEN 1 ELSE 0 END) as 'Success',
            ROUND(SUM(CASE WHEN success = 1 THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 1) || '%' as 'Rate'
        FROM tool_uses
        WHERE timestamp >= datetime('now', '-$days days')
        GROUP BY tool_name
        ORDER BY COUNT(*) DESC;
    "
}

# Show file changes
show_files() {
    check_db
    local limit="${1:-20}"

    echo -e "${BOLD}${CYAN}Most Modified Files (top $limit)${NC}"
    echo -e "${DIM}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"

    sqlite3 -cmd ".timeout 5000" -header -column "$DB_FILE" "
        SELECT
            substr(file_path, -50) as 'File',
            COUNT(*) as 'Changes',
            SUM(lines_added) as '+Lines',
            SUM(lines_removed) as '-Lines'
        FROM file_changes
        GROUP BY file_path
        ORDER BY COUNT(*) DESC
        LIMIT $limit;
    "
}

# Show git operations
show_git() {
    check_db
    local days="${1:-7}"

    echo -e "${BOLD}${CYAN}Git Operations (last $days days)${NC}"
    echo -e "${DIM}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"

    sqlite3 -cmd ".timeout 5000" -header -column "$DB_FILE" "
        SELECT
            operation_type as 'Operation',
            COUNT(*) as 'Count',
            SUM(CASE WHEN exit_code = 0 THEN 1 ELSE 0 END) as 'Success',
            SUM(CASE WHEN exit_code != 0 THEN 1 ELSE 0 END) as 'Failed'
        FROM git_operations
        WHERE timestamp >= datetime('now', '-$days days')
        GROUP BY operation_type
        ORDER BY COUNT(*) DESC;
    "
}

# Show daily trends
show_daily() {
    check_db
    local days="${1:-14}"

    echo -e "${BOLD}${CYAN}Daily Activity (last $days days)${NC}"
    echo -e "${DIM}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"

    sqlite3 -cmd ".timeout 5000" -header -column "$DB_FILE" "
        SELECT
            date(timestamp) as 'Date',
            COUNT(DISTINCT session_id) as 'Sessions',
            COUNT(*) as 'Tools',
            SUM(CASE WHEN tool_name IN ('Write', 'Edit') THEN 1 ELSE 0 END) as 'Writes'
        FROM tool_uses
        WHERE timestamp >= datetime('now', '-$days days')
        GROUP BY date(timestamp)
        ORDER BY date(timestamp) DESC;
    "
}

# Show projects
show_projects() {
    check_db

    echo -e "${BOLD}${CYAN}Projects by Activity${NC}"
    echo -e "${DIM}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"

    sqlite3 -cmd ".timeout 5000" -header -column "$DB_FILE" "
        SELECT
            COALESCE(project_name, '(unknown)') as 'Project',
            COUNT(*) as 'Sessions',
            (SELECT COUNT(*) FROM tool_uses t WHERE t.session_id IN
                (SELECT session_id FROM sessions s2 WHERE s2.project_name = s.project_name)
            ) as 'Tool Uses',
            datetime(MAX(start_time), 'localtime') as 'Last Active'
        FROM sessions s
        WHERE project_name IS NOT NULL AND project_name != ''
        GROUP BY project_name
        ORDER BY MAX(start_time) DESC
        LIMIT 20;
    "
}

# Show time-based analytics
show_times() {
    check_db

    echo -e "${BOLD}${CYAN}Time Analytics${NC}"
    echo -e "${DIM}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    echo

    # Total time spent (completed sessions only)
    TOTAL_TIME=$(sqlite3 -cmd ".timeout 5000" "$DB_FILE" "
        SELECT COALESCE(
            printf('%d hrs %d mins',
                SUM(strftime('%s', end_time) - strftime('%s', start_time)) / 3600,
                (SUM(strftime('%s', end_time) - strftime('%s', start_time)) % 3600) / 60
            ),
            '0 hrs 0 mins'
        )
        FROM sessions
        WHERE end_time IS NOT NULL;
    ")

    AVG_SESSION=$(sqlite3 -cmd ".timeout 5000" "$DB_FILE" "
        SELECT COALESCE(
            printf('%d mins',
                AVG(strftime('%s', end_time) - strftime('%s', start_time)) / 60
            ),
            '0 mins'
        )
        FROM sessions
        WHERE end_time IS NOT NULL;
    ")

    LONGEST_SESSION=$(sqlite3 -cmd ".timeout 5000" "$DB_FILE" "
        SELECT COALESCE(
            printf('%d mins',
                MAX(strftime('%s', end_time) - strftime('%s', start_time)) / 60
            ),
            '0 mins'
        )
        FROM sessions
        WHERE end_time IS NOT NULL;
    ")

    # Today's time
    TODAY_TIME=$(sqlite3 -cmd ".timeout 5000" "$DB_FILE" "
        SELECT COALESCE(
            printf('%d hrs %d mins',
                SUM(
                    strftime('%s', COALESCE(end_time, datetime('now'))) - strftime('%s', start_time)
                ) / 3600,
                (SUM(
                    strftime('%s', COALESCE(end_time, datetime('now'))) - strftime('%s', start_time)
                ) % 3600) / 60
            ),
            '0 hrs 0 mins'
        )
        FROM sessions
        WHERE date(start_time) = date('now');
    ")

    echo -e "${BOLD}â±  Session Duration${NC}"
    echo -e "   Total Time:         ${GREEN}$TOTAL_TIME${NC}"
    echo -e "   Today's Time:       ${CYAN}$TODAY_TIME${NC}"
    echo -e "   Average Session:    ${YELLOW}$AVG_SESSION${NC}"
    echo -e "   Longest Session:    ${BLUE}$LONGEST_SESSION${NC}"
    echo

    echo -e "${BOLD}ðŸ“… Activity by Hour (Last 7 Days)${NC}"
    sqlite3 -cmd ".timeout 5000" -header -column "$DB_FILE" "
        SELECT
            printf('%02d:00', strftime('%H', timestamp)) as 'Hour',
            COUNT(*) as 'Tool Calls',
            COUNT(DISTINCT session_id) as 'Sessions'
        FROM tool_uses
        WHERE timestamp >= datetime('now', '-7 days')
        GROUP BY strftime('%H', timestamp)
        ORDER BY strftime('%H', timestamp);
    "
    echo

    echo -e "${BOLD}ðŸ“† Activity by Day of Week${NC}"
    sqlite3 -cmd ".timeout 5000" -header -column "$DB_FILE" "
        SELECT
            CASE strftime('%w', timestamp)
                WHEN '0' THEN 'Sunday'
                WHEN '1' THEN 'Monday'
                WHEN '2' THEN 'Tuesday'
                WHEN '3' THEN 'Wednesday'
                WHEN '4' THEN 'Thursday'
                WHEN '5' THEN 'Friday'
                WHEN '6' THEN 'Saturday'
            END as 'Day',
            COUNT(*) as 'Tool Calls',
            COUNT(DISTINCT date(timestamp)) as 'Active Days'
        FROM tool_uses
        GROUP BY strftime('%w', timestamp)
        ORDER BY strftime('%w', timestamp);
    "
}

# Show hourly heatmap
show_hourly() {
    check_db

    echo -e "${BOLD}${CYAN}Hourly Activity Heatmap (Last 30 Days)${NC}"
    echo -e "${DIM}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    echo

    # Get max count for scaling
    MAX_COUNT=$(sqlite3 -cmd ".timeout 5000" "$DB_FILE" "
        SELECT MAX(cnt) FROM (
            SELECT COUNT(*) as cnt
            FROM tool_uses
            WHERE timestamp >= datetime('now', '-30 days')
            GROUP BY strftime('%H', timestamp)
        );
    ")

    if [[ -z "$MAX_COUNT" ]] || [[ "$MAX_COUNT" == "0" ]]; then
        echo -e "${DIM}No activity data yet.${NC}"
        return
    fi

    echo -e "Hour  Activity"
    echo -e "â”€â”€â”€â”€  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

    for hour in $(seq -w 0 23); do
        COUNT=$(sqlite3 -cmd ".timeout 5000" "$DB_FILE" "
            SELECT COUNT(*)
            FROM tool_uses
            WHERE timestamp >= datetime('now', '-30 days')
            AND strftime('%H', timestamp) = '$hour';
        ")

        # Calculate bar length (max 40 chars)
        if [[ "$MAX_COUNT" -gt 0 ]]; then
            BAR_LEN=$((COUNT * 40 / MAX_COUNT))
        else
            BAR_LEN=0
        fi

        # Build the bar
        BAR=""
        for ((i=0; i<BAR_LEN; i++)); do
            BAR="${BAR}â–ˆ"
        done

        # Color based on intensity
        if [[ $BAR_LEN -gt 30 ]]; then
            COLOR=$GREEN
        elif [[ $BAR_LEN -gt 15 ]]; then
            COLOR=$YELLOW
        elif [[ $BAR_LEN -gt 0 ]]; then
            COLOR=$BLUE
        else
            COLOR=$DIM
        fi

        printf "%s:00  ${COLOR}%-40s${NC} %d\n" "$hour" "$BAR" "$COUNT"
    done
}

# Show session timeline
show_timeline() {
    check_db
    local days="${1:-7}"

    echo -e "${BOLD}${CYAN}Session Timeline (Last $days Days)${NC}"
    echo -e "${DIM}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"

    sqlite3 -cmd ".timeout 5000" -header -column "$DB_FILE" "
        SELECT
            date(start_time, 'localtime') as 'Date',
            time(start_time, 'localtime') as 'Start',
            COALESCE(time(end_time, 'localtime'), 'Active') as 'End',
            CASE
                WHEN end_time IS NULL THEN 'Running'
                ELSE printf('%d min', (strftime('%s', end_time) - strftime('%s', start_time)) / 60)
            END as 'Duration',
            project_name as 'Project',
            (SELECT COUNT(*) FROM tool_uses t WHERE t.session_id = s.session_id) as 'Tools'
        FROM sessions s
        WHERE start_time >= datetime('now', '-$days days')
        ORDER BY start_time DESC;
    "
}

# Export data to JSON
export_json() {
    check_db
    local output="${1:-analytics-export.json}"

    echo -e "${CYAN}Exporting analytics to $output...${NC}"

    sqlite3 -cmd ".timeout 5000" "$DB_FILE" "
        SELECT json_object(
            'exported_at', datetime('now'),
            'summary', json_object(
                'total_sessions', (SELECT COUNT(*) FROM sessions),
                'total_tool_uses', (SELECT COUNT(*) FROM tool_uses),
                'total_files_changed', (SELECT COUNT(DISTINCT file_path) FROM file_changes),
                'total_git_operations', (SELECT COUNT(*) FROM git_operations),
                'lines_added', (SELECT COALESCE(SUM(lines_added), 0) FROM file_changes),
                'lines_removed', (SELECT COALESCE(SUM(lines_removed), 0) FROM file_changes)
            )
        );
    " > "$output"

    echo -e "${GREEN}Export complete: $output${NC}"
}

# Reset/clear analytics
reset_analytics() {
    check_db

    echo -e "${YELLOW}WARNING: This will delete all analytics data!${NC}"
    read -p "Are you sure? (type 'yes' to confirm): " confirm

    if [[ "$confirm" == "yes" ]]; then
        rm -f "$DB_FILE"
        echo -e "${GREEN}Analytics data has been reset.${NC}"
    else
        echo -e "${DIM}Cancelled.${NC}"
    fi
}

# ============================================
# CLOUD SYNC COMMANDS
# ============================================

# Source db.sh for cloud functions
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LIB_DIR="$(dirname "$SCRIPT_DIR")/lib"
if [[ -f "$LIB_DIR/db.sh" ]]; then
    source "$LIB_DIR/db.sh"
elif [[ -f "$HOME/.claude/analytics/lib/db.sh" ]]; then
    source "$HOME/.claude/analytics/lib/db.sh"
fi

# Login to cloud
cloud_login() {
    local api_key="$1"
    local api_url="${2:-https://claude-analytics.vercel.app}"

    if [[ -z "$api_key" ]]; then
        echo -e "${BOLD}${CYAN}Cloud Login${NC}"
        echo
        echo -e "Enter your API key (from ${CYAN}$api_url/settings${NC}):"
        read -r api_key
    fi

    if [[ -z "$api_key" ]]; then
        echo -e "${RED}Error: API key is required${NC}"
        exit 1
    fi

    echo -e "${DIM}Verifying API key...${NC}"

    # Test the API key
    local response=$(curl -s -w "\n%{http_code}" \
        -H "Authorization: Bearer $api_key" \
        "$api_url/api/analytics/summary")

    local http_code=$(echo "$response" | tail -n1)
    local body=$(echo "$response" | sed '$d')

    if [[ "$http_code" == "200" ]]; then
        # Save credentials
        save_cloud_auth "$api_key" "$api_url"

        echo -e "${GREEN}âœ“ Successfully logged in!${NC}"
        echo
        echo -e "Your analytics will now sync to the cloud."
        echo -e "Run ${CYAN}tokenscope sync${NC} to sync existing data."
    else
        echo -e "${RED}Error: Invalid API key or server error (HTTP $http_code)${NC}"
        echo -e "${DIM}$body${NC}"
        exit 1
    fi
}

# Logout from cloud
cloud_logout() {
    if ! is_logged_in 2>/dev/null; then
        echo -e "${YELLOW}Not logged in to cloud.${NC}"
        return
    fi

    clear_cloud_auth
    echo -e "${GREEN}âœ“ Logged out from cloud.${NC}"
    echo -e "${DIM}Local analytics data is preserved.${NC}"
}

# Show cloud status
cloud_status() {
    echo -e "${BOLD}${CYAN}Cloud Sync Status${NC}"
    echo -e "${DIM}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    echo

    if ! is_logged_in 2>/dev/null; then
        echo -e "  Status:        ${YELLOW}Not connected${NC}"
        echo
        echo -e "  Run ${CYAN}tokenscope login${NC} to connect to cloud."
        return
    fi

    # Get auth info
    local auth_json=$(get_cloud_auth)
    local email=$(echo "$auth_json" | jq -r '.[0].email // "unknown"')
    local api_url=$(echo "$auth_json" | jq -r '.[0].api_url // "unknown"')
    local last_sync_utc=$(echo "$auth_json" | jq -r '.[0].last_sync // "never"')
    # Convert UTC to local time for display
    local last_sync="$last_sync_utc"
    if [[ "$last_sync_utc" != "never" && "$last_sync_utc" != "null" ]]; then
        # Parse UTC time to epoch, then format in local timezone
        local epoch=$(TZ=UTC date -j -f "%Y-%m-%d %H:%M:%S" "$last_sync_utc" "+%s" 2>/dev/null)
        if [[ -n "$epoch" ]]; then
            last_sync=$(date -j -r "$epoch" "+%Y-%m-%d %H:%M:%S" 2>/dev/null || echo "$last_sync_utc")
        fi
    fi

    echo -e "  Status:        ${GREEN}Connected${NC}"
    echo -e "  Email:         ${CYAN}$email${NC}"
    echo -e "  Server:        $api_url"
    echo -e "  Last Sync:     $last_sync"
    echo

    # Get sync stats
    if is_sync_enabled 2>/dev/null; then
        local stats=$(get_sync_stats)
        local unsynced_sessions=$(echo "$stats" | cut -d'|' -f1)
        local unsynced_tools=$(echo "$stats" | cut -d'|' -f2)
        local unsynced_files=$(echo "$stats" | cut -d'|' -f3)
        local unsynced_git=$(echo "$stats" | cut -d'|' -f4)
        local unsynced_skills=$(echo "$stats" | cut -d'|' -f5)
        local unsynced_agents=$(echo "$stats" | cut -d'|' -f6)
        local unsynced_plugins=$(echo "$stats" | cut -d'|' -f7)

        local total_unsynced=$((unsynced_sessions + unsynced_tools + unsynced_files + unsynced_git + unsynced_skills + unsynced_agents + unsynced_plugins))

        echo -e "${BOLD}Pending Sync:${NC}"
        echo -e "  Sessions:      $unsynced_sessions"
        echo -e "  Tool Uses:     $unsynced_tools"
        echo -e "  File Changes:  $unsynced_files"
        echo -e "  Git Ops:       $unsynced_git"
        echo -e "  Skills:        $unsynced_skills"
        echo -e "  Agents:        $unsynced_agents"
        echo -e "  Plugins:       $unsynced_plugins"
        echo -e "  ${BOLD}Total:${NC}         ${YELLOW}$total_unsynced${NC} records"

        if [[ $total_unsynced -gt 0 ]]; then
            echo
            echo -e "  Run ${CYAN}tokenscope sync${NC} to sync now."
        fi
    fi
}

# Sync data to cloud
cloud_sync() {
    local quiet="${1:-}"

    if ! is_logged_in 2>/dev/null; then
        [[ "$quiet" != "--quiet" ]] && echo -e "${RED}Error: Not logged in. Run 'tokenscope login' first.${NC}"
        exit 1
    fi

    # Ensure sync columns exist
    if ! is_sync_enabled 2>/dev/null; then
        [[ "$quiet" != "--quiet" ]] && echo -e "${DIM}Migrating database for sync...${NC}"
        migrate_for_sync 2>/dev/null
    fi

    [[ "$quiet" != "--quiet" ]] && echo -e "${BOLD}${CYAN}Syncing to Cloud${NC}"
    [[ "$quiet" != "--quiet" ]] && echo

    # Get auth info
    local auth_json=$(get_cloud_auth)
    local api_key=$(echo "$auth_json" | jq -r '.[0].api_key')
    local api_url=$(echo "$auth_json" | jq -r '.[0].api_url')

    # Get unsynced data
    local sessions=$(get_unsynced_sessions)
    local tool_uses=$(get_unsynced_tool_uses)
    local file_changes=$(get_unsynced_file_changes)
    local git_ops=$(get_unsynced_git_ops)
    local skill_uses=$(get_unsynced_skill_uses 2>/dev/null || echo "[]")
    local agent_spawns=$(get_unsynced_agent_spawns 2>/dev/null || echo "[]")
    local plugins=$(get_unsynced_plugins 2>/dev/null || echo "[]")

    # Count records
    local session_count=$(echo "$sessions" | jq -r 'length // 0' 2>/dev/null || echo "0")
    local tool_count=$(echo "$tool_uses" | jq -r 'length // 0' 2>/dev/null || echo "0")
    local file_count=$(echo "$file_changes" | jq -r 'length // 0' 2>/dev/null || echo "0")
    local git_count=$(echo "$git_ops" | jq -r 'length // 0' 2>/dev/null || echo "0")
    local skill_count=$(echo "$skill_uses" | jq -r 'length // 0' 2>/dev/null || echo "0")
    local agent_count=$(echo "$agent_spawns" | jq -r 'length // 0' 2>/dev/null || echo "0")
    local plugin_count=$(echo "$plugins" | jq -r 'length // 0' 2>/dev/null || echo "0")

    local total=$((session_count + tool_count + file_count + git_count + skill_count + agent_count + plugin_count))

    if [[ $total -eq 0 ]]; then
        [[ "$quiet" != "--quiet" ]] && echo -e "${GREEN}âœ“ Everything is synced!${NC}"
        return
    fi

    [[ "$quiet" != "--quiet" ]] && echo -e "  Syncing $session_count sessions, $tool_count tool uses, $file_count file changes, $git_count git ops, $skill_count skills, $agent_count agents, $plugin_count plugins..."
    [[ "$quiet" != "--quiet" ]] && echo

    # Build payload
    local payload=$(jq -n \
        --argjson sessions "$sessions" \
        --argjson tool_uses "$tool_uses" \
        --argjson file_changes "$file_changes" \
        --argjson git_operations "$git_ops" \
        --argjson skill_uses "$skill_uses" \
        --argjson agent_spawns "$agent_spawns" \
        --argjson installed_plugins "$plugins" \
        '{sessions: $sessions, tool_uses: $tool_uses, file_changes: $file_changes, git_operations: $git_operations, skill_uses: $skill_uses, agent_spawns: $agent_spawns, installed_plugins: $installed_plugins}')

    # Send to API
    local response=$(curl -s -w "\n%{http_code}" \
        -X POST \
        -H "Authorization: Bearer $api_key" \
        -H "Content-Type: application/json" \
        -d "$payload" \
        "$api_url/api/sync")

    local http_code=$(echo "$response" | tail -n1)
    local body=$(echo "$response" | sed '$d')

    if [[ "$http_code" == "200" ]]; then
        # Mark as synced
        mark_sessions_synced
        mark_tool_uses_synced
        mark_file_changes_synced
        mark_git_ops_synced
        mark_skill_uses_synced 2>/dev/null || true
        mark_agent_spawns_synced 2>/dev/null || true
        mark_plugins_synced 2>/dev/null || true
        update_last_sync

        if [[ "$quiet" != "--quiet" ]]; then
            local synced=$(echo "$body" | jq -r '.synced')
            echo -e "${GREEN}âœ“ Sync complete!${NC}"
            echo -e "  Sessions:      $(echo "$synced" | jq -r '.sessions // 0')"
            echo -e "  Tool Uses:     $(echo "$synced" | jq -r '.tool_uses // 0')"
            echo -e "  File Changes:  $(echo "$synced" | jq -r '.file_changes // 0')"
            echo -e "  Git Ops:       $(echo "$synced" | jq -r '.git_operations // 0')"
            echo -e "  Skills:        $(echo "$synced" | jq -r '.skill_uses // 0')"
            echo -e "  Agents:        $(echo "$synced" | jq -r '.agent_spawns // 0')"
            echo -e "  Plugins:       $(echo "$synced" | jq -r '.installed_plugins // 0')"
        fi

        log_sync "sync_complete" "$total"
    else
        [[ "$quiet" != "--quiet" ]] && echo -e "${RED}Sync failed (HTTP $http_code)${NC}"
        [[ "$quiet" != "--quiet" ]] && echo -e "${DIM}$body${NC}"
        log_sync "sync_error" "0" "HTTP $http_code"
        exit 1
    fi
}

# Show help
show_help() {
    echo -e "${BOLD}TokenScope CLI${NC}"
    echo
    echo -e "${BOLD}Usage:${NC} tokenscope <command> [options]"
    echo
    echo -e "${BOLD}Local Analytics:${NC}"
    echo -e "  ${GREEN}summary${NC}            Show overview dashboard (default)"
    echo -e "  ${GREEN}sessions${NC} [n]       List recent sessions (default: 10)"
    echo -e "  ${GREEN}tools${NC} [days]       Show tool usage breakdown (default: 7 days)"
    echo -e "  ${GREEN}files${NC} [n]          Show most modified files (default: 20)"
    echo -e "  ${GREEN}git${NC} [days]         Show git operations (default: 7 days)"
    echo -e "  ${GREEN}daily${NC} [days]       Show daily activity trends (default: 14 days)"
    echo -e "  ${GREEN}times${NC}              Show time analytics (durations, hourly, weekly)"
    echo -e "  ${GREEN}hourly${NC}             Show hourly activity heatmap"
    echo -e "  ${GREEN}timeline${NC} [days]    Show session timeline (default: 7 days)"
    echo -e "  ${GREEN}projects${NC}           Show projects by activity"
    echo -e "  ${GREEN}export${NC} [file]      Export data to JSON"
    echo -e "  ${GREEN}reset${NC}              Clear all analytics data"
    echo
    echo -e "${BOLD}Cloud Sync:${NC}"
    echo -e "  ${GREEN}login${NC} [key]        Login to cloud with API key"
    echo -e "  ${GREEN}logout${NC}             Logout from cloud"
    echo -e "  ${GREEN}status${NC}             Show cloud connection status"
    echo -e "  ${GREEN}sync${NC} [--quiet]     Sync local data to cloud"
    echo
    echo -e "${BOLD}Other:${NC}"
    echo -e "  ${GREEN}help${NC}               Show this help message"
    echo
    echo -e "${BOLD}Examples:${NC}"
    echo -e "  tokenscope                    # Show summary"
    echo -e "  tokenscope sessions 20        # Show last 20 sessions"
    echo -e "  tokenscope login sk_abc123    # Login with API key"
    echo -e "  tokenscope sync               # Sync to cloud"
    echo
    echo -e "${DIM}Database location: $DB_FILE${NC}"
}

# Main command routing
case "${1:-summary}" in
    summary|s)
        show_summary
        ;;
    sessions|sess)
        show_sessions "${2:-10}"
        ;;
    tools|t)
        show_tools "${2:-7}"
        ;;
    files|f)
        show_files "${2:-20}"
        ;;
    git|g)
        show_git "${2:-7}"
        ;;
    daily|d)
        show_daily "${2:-14}"
        ;;
    times|time)
        show_times
        ;;
    hourly|heatmap)
        show_hourly
        ;;
    timeline|tl)
        show_timeline "${2:-7}"
        ;;
    projects|p)
        show_projects
        ;;
    export|e)
        export_json "${2:-analytics-export.json}"
        ;;
    reset)
        reset_analytics
        ;;
    login)
        cloud_login "${2:-}" "${3:-}"
        ;;
    logout)
        cloud_logout
        ;;
    status|cloud)
        cloud_status
        ;;
    sync)
        cloud_sync "${2:-}"
        ;;
    help|h|-h|--help)
        show_help
        ;;
    *)
        echo -e "${RED}Unknown command: $1${NC}"
        echo
        show_help
        exit 1
        ;;
esac
